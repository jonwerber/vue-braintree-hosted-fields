<template>
    <div :class="wrapperClass">

        <div v-show="!hostedFieldsInstance" class="loader" id="loader-1"></div>

        <div v-show="hostedFieldsInstance">

            <div class="line" v-if="collectCardHolderName">
                <label for="cardholder">Card Holder *
                    <input type="text" class="input-field" id="cardholder" name="cardholder" placeholder="Name">
                </label>
            </div>

            <div class="line">
                <label for="card-number">Card Number *
                    <div class="input-field" id="number"></div>
                </label>

                <label for="postal" v-if="collectPostalCode">Postal Code *
                    <input type="text" class="input-field" id="postal" name="postal" placeholder="11111">
                </label>
            </div>

            <div class="line">

                <div class="expiration-container">
                    <label for="expiration-month">Expiration Month *
                        <div class="input-field" id="expiration-month"></div>
                    </label>
                    <div class="expiration-spacer"></div>

                    <label for="expiration-year">Expiration Year *
                        <div class="input-field" id="expiration-year"></div>
                    </label>
                </div>
                <label for="cvv">CVV *
                    <div class="input-field" id="cvv"></div>
                </label>
            </div>

        </div>

    </div>
</template>

<script>
    export default {
        props: {
            authToken: {
                value: String,
            },
            wrapperClass: {
                value: String,
            },
            loaderClass: {
                value: String,
            },
            inputClass: {
                value: String,
            },
            collectCardHolderName: {
                value: Boolean,
            },
            collectPostalCode: {
                value: Boolean,
            },
            enableDataCollector: {
                value: Boolean,
            }
        },
        created() {
            this.createBT();

            this.$parent.$on('tokenize', () => {
                this.tokenizeHF();
            });
        },
        data () {
            return {
                errorMessage: '',
                clientInstance: '',
                hostedFieldsInstance: '',
                tokenizePayload: '',
                dataCollectorPayload: '',
            }
        },
        methods: {
            createBT () {
                const client = require('braintree-web/client');
                client.create({
                    authorization: this.authToken
                }, (clientErr, clientInstance) => {
                    if (clientErr) {
                        this.errorMessage = 'There was an error setting up the client instance. Message: ' + clientErr.message;
                        this.$emit('bthferror', this.errorMessage);
                        return;
                    } else {
                        this.clientInstance = clientInstance
                        this.createHF();

                        if (this.enableDataCollector) {
                            this.dataCollectorCreate();
                        }
                    }
                });
            },
            createHF () {
                const hostedFields = require('braintree-web/hosted-fields');
                hostedFields.create({
                    client: this.clientInstance,
                    styles: {
                        'input': {
                            'font-size': '18px'
                        },
                        'input.invalid': {
                            'color': 'red'
                        },
                        'input.valid': {
                            'color': 'green'
                        }
                    },
                    fields: {
                        number: {
                            selector: '#number',
                            placeholder: '4111 1111 1111 1111',
                        },
                        cvv: {
                            selector: '#cvv',
                            placeholder: '123',
                        },
                        expirationMonth: {
                            selector: '#expiration-month',
                            placeholder: 'Expiration month',
                            select: {
                                options: [
                                    '01 - January',
                                    '02 - February',
                                    '03 - March',
                                    '04 - April',
                                    '05 - May',
                                    '06 - June',
                                    '07 - July',
                                    '08 - August',
                                    '09 - September',
                                    '10 - October',
                                    '11 - November',
                                    '12 - December'
                                ]
                            }
                        },
                        expirationYear: {
                            selector: '#expiration-year',
                            placeholder: 'Expiration year',
                            select: true
                        },
                    },
                }, (hostedFieldsErr, hostedFieldsInstance) => {
                    if (hostedFieldsErr) {
                        // Handle error in Hosted Fields creation
                        this.errorMessage = 'There was an error setting up the hosted fields! Message: ' + hostedFieldsErr.message;
                        this.$emit('bthferror', this.errorMessage);
                        return;
                    } else {
                        this.$emit('bthfready');
                        this.hostedFieldsInstance = hostedFieldsInstance;
                    }

                });
            },
            tokenizeHF () {
                const additionalFields = {
                    cardholderName: '',
                    billingAddress: {
                        postalCode: '',
                    },
                };
                if (this.collectCardHolderName) {
                    additionalFields.cardholderName = document.querySelector('#cardholder').value;
                }
                if (this.collectPostalCode) {
                    additionalFields.billingAddress.postalCode = document.querySelector('#postal').value;
                }
                console.log(additionalFields);
                this.hostedFieldsInstance.tokenize(additionalFields, (tokenizeErr, payload) => {
                    if (tokenizeErr) {
                        this.errorMessage = 'There was an error tokenizing! Message: ' + tokenizeErr.message;
                        this.$emit('bthferror', this.errorMessage);
                        return;
                    }

                    this.tokenizePayload = payload;
                    this.$emit('bthfpayload', payload);
                    this.teardownHF();

                });
            },
            teardownHF () {
                this.hostedFieldsInstance.teardown((teardownErr) => {
                    if (teardownErr) {
                        this.errorMessage = 'There was an error tearing it down! Message: ' + teardownErr.message;
                        this.$emit('bthferror', this.errorMessage);
                        return;
                    } else {
                        this.hostedFieldsInstance = '';
                        return;
                    }
                });
            },
            dataCollectorCreate() {
                const dataCollector = require('braintree-web/data-collector');
                dataCollector.create({
                    client: this.clientInstance,
                    kount: true,
                }, (dataCollectorErr, dataCollectorInstance) => {
                    if (dataCollectorErr) {
                        this.errorMessage = 'There was an error setting up the data collector! Message: ' + dataCollectorErr.message;
                        this.$emit('bthferror', this.dataCollectorErr);
                        return;
                    }

                    this.$emit('device.data.payload', dataCollectorInstance.deviceData);
                    this.dataCollectorPayload = dataCollectorInstance;

                });

            }
        },
    };
</script>

<style>
    .loader {
        width: 50px;
        height: 50px;
        border-radius: 100%;
        position: relative;
        margin: 0 auto;
    }

    /* LOADER 1 */

    #loader-1:before, #loader-1:after {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        width: 100%;
        height: 100%;
        border-radius: 100%;
        border: 10px solid transparent;
        border-top-color: #3498db;
    }

    #loader-1:before {
        z-index: 100;
        animation: spin 1s infinite;
    }

    #loader-1:after {
        border: 10px solid #ccc;
    }


    .expiration-container{
        display: flex;
    }
    .expiration-spacer{
        width: 5%;
    }
   
    @keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
</style>
